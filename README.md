# @selfage/message

## Install

`npm install @selfage/message`

## Overview

Written in TypeScript and compiled to ES6. Provides message descriptor definitions and utils to assist runtime processing. A message descriptor is typically generated by using `@selfage/cli`.

The term "message" stands for data class, inspired from Google's protobuf. I.e., in JavaScript/TypeScript case, an object without any functions defined on it,
which is what can be communicated between different threads, processes, or distributed servers.

A descriptor is an object holding information, even at runtime, about how a message is defined, just like declaring a TypeScript `interface`, except that an interface is erased at runtime.

## Generate MessageDescriptor

Technically, you can generate a `MessageDescriptor` manually, or by using a generator of yours.

By using `@selfage/cli`, it requires a JSON file as input, e.g. `basic.json`, to describe the message as the following.

```JSON
[{
  "message": {
    "name": "BasicData",
    "fields": [{
      "name": "numberField",
      "type": "number"
    }, {
      "name": "stringArrayField",
      "type": "string",
      "isArray": true
    }]
  }
}]
```

It's just like a TypeScript interface but a little bit verbose when written in JSON. The schema of the JSON file is an array of [Definition](https://github.com/selfage/cli/blob/7e4116eb6d07597736458f07ba871ad6ab940eec/generate/definition.ts#L55).

After running `$ selfage/cli gen basic`, you will get a `basic.ts` file, which looks like the follwing.

```TypeScript
import { MessageDescriptor, PrimitiveType } from '@selfage/message/descriptor';

export interface BasicData {
  numberField?: number,
  stringArrayField?: Array<string>
}

export let BASIC_DATA: MessageDescriptor<BasicData> = {
  name: 'BasicData',
  factoryFn: () => {
    return new Object();
  },
  fields: [
    {
      name: 'numberField',
      primitiveType: PrimitiveType.NUMBER,
    },
    {
      name: 'stringArrayField',
      primitiveType: PrimitiveType.STRING,
      arrayFactoryFn: () => {
        return new Array<any>();
      },
    },
  ]
};
```

It's recommended to commit `basic.ts` as a source file such that any code change on `@selfage/cli` will not break your program. `basic.ts` can be imported as any other source file. `BasicData` is a regular TypeScript interface. `BASIC_DATA` is a singleton instance of `MessageDescriptor` that can be passed around.

## Parse messages at runtime

With a `MessageDescriptor`, you can then parse an `any` object into a typed object by validating each field type, e.g., from a JSON-parsed object.

```TypeScript
import { parseMessage } from '@selfage/message/parser';
import { BASIC_DATA, BasicData } from './basic'; // As generated from the example above.

let raw = JSON.parse(`{ "numberField": 111, "otherField": "random", "stringArrayField": ["str1", "str2"] }`);
let basicData = parseMessage(raw, BASIC_DATA); // Of type `BasicData`.
basicData.numberField; // 111
basicData.stringArrayField; // ["str1", "str2"]
basicData.otherField; // undefined
```

You can also supply an in-place output.

```TypeScript
// ...
let output: BasicData = {};
parseMessage(raw, BASIC_DATA, output);
```

## Generate EnumDescriptor

TypeScript preserves enum information at runtime. Therefore, `EnumDescriptor` only exists for `MessageDescriptor` to reference.

An example JSON file, `color.json`, is as the following.

```JSON
[{
  "enum": {
    "name": "Color",
    "values": [{
      "name": "RED",
      "value": 12
    }, {
      "name": "BLUE",
      "value": 1
    }]
  }
}]
```

With `@selfage/cli`, you will get `color.ts` as the following.

```TypeScript
import { EnumDescriptor } from '@selfage/message/descriptor';

export enum Color {
  RED = 12,
  BLUE = 1,
}

export let COLOR: EnumDescriptor<Color> = {
  name: 'Color',
  values: [
    {
      name: 'RED',
      value: 12,
    },
    {
      name: 'BLUE',
      value: 1,
    },
  ]
}
```

## Parse enums at runtime

Also because TypeScript perserves enum information at runtime. The following parser is mainly used when parsing messages.

```TypeScript
import { parseEnum } from '@selfage/message/parser';
import { COLOR, Color } from './color'; // As generated from the example above.

let raw = 1 as any;
let blue = parseEnum(raw, COLOR); // of type Color.
let raw2 = 'RED' as any;
let red = parseEnum(raw2, COLOR); // of type Color.
```

## Test matcher

Provides an implementation of test matcher to be used with `@selfage/test_base`.

```TypeScript
import { BasicData, BASIC_DATA } from './basic'; // As generated from the example above.
import { eqMessage } from '@selfage/message/test_matcher';
import { assertThat } from '@selfage/test_base/matcher'; // Install @selfage/test_base

let basicData: BasicData = { numberField: 111 };
assertThat(basicData, eqMessage({ numberField: 111 }, BASIC_DATA), `basicData`);
```
